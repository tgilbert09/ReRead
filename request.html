<!doctype html>
<html class="no-js" lang="">

<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ReRead</title>
<link rel="stylesheet" href="css/style.css">
<link rel="stylesheet" href="css/request.css">
<meta name="description" content="">

<meta property="og:title" content="">
<meta property="og:type" content="">
<meta property="og:url" content="">
<meta property="og:image" content="">
<meta property="og:image:alt" content="">

<link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="./favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="./favicon-16x16.png">
<link rel="manifest" href="./site.webmanifest">
<link rel="mask-icon" href="./safari-pinned-tab.svg" color="#fcfbf8">
<meta name="msapplication-TileColor" content="#ffc40d">
<meta name="theme-color" content="#fcfbf8">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link
href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"
rel="stylesheet">

<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,300,0,0"
rel="stylesheet">
<meta name="theme-color" content="#fafafa">
</head>

<body>
<div class="topnav">
<a href="./index.html"><img id="ReRead_logo" src="./ReReadLogo_Regular.svg" alt="ReRead's logo">
<h1>ReRead</h1>
</a>
<a href="javascript:void(0);" class='icon' onclick="myFunction()">
<div class="line"></div>
<div class="line"></div>
</a>
<div class="split" id="myTopnav">
<a href="./index.html">H<span>om</span>e</a>
<a href="./request.html">R<span>eques</span>t</a>
<a href="./blog.html">B<span>lo</span>g</a>
</div>
</div>

<div class="bookRequest">
<div class="widthLimit">
<h2>Request a book...</h2>
<a href="./blogs/howReReadWorks.html">Learn about how ReRead works ></a>
<form
action="https://docs.google.com/forms/u/0/d/e/1FAIpQLScFMnCyO7QgUGV63ZIh0Lfrq7NRD2meC10ZqJc44TG-nJQA3w/formResponse"
autocomplete="on">
<label for="book">Book title & author or ISBN</label>
<input type="text" id="book" name="entry.1670138469" placeholder="Book title & author or ISBN"
autocomplete="off">
<br><br>
<label for="email">Email</label>
<input type="email" id="email" name="entry.1176417087" placeholder="Email"><br>
<br>
<p>You will receive an email when your book is found!</p>

<p>There is a Â£1 reservation fee payable if you wish to reserve your book at the charity shop.</p>
<p>Limited to Bristol.</p>
<input type="submit" value="Send">
</form>
</div>
</div>


<div class="browseBooks">
<h2>Browse local books!</h2>
<p>Below is in development...</p>
<div class="search-container">
<form id="search-form">
<input type="text" id="search-input" placeholder="Search books.." name="search">
<button type="submit">Search</button>
</form>
<table id="bookList"></table>
</div>



<script>
function myFunction() {
	var x = document.getElementById("myTopnav");
	if (x.className === "split") {
		x.className += " responsive";
	} else {
		x.className = "split";
	}
}
</script>

<script>
function timeAgo(dateString) {
    const now = new Date();
    const pastDate = new Date(dateString);
    const diffInMs = now - pastDate; // Difference in milliseconds
    const diffInSeconds = Math.floor(diffInMs / 1000); // Difference in seconds
    const diffInMinutes = Math.floor(diffInSeconds / 60);
    const diffInHours = Math.floor(diffInMinutes / 60);
    const diffInDays = Math.floor(diffInHours / 24);

    if (diffInSeconds < 60) {
        return "a moment ago";
    } else if (diffInMinutes < 60) {
        return diffInMinutes + " minute" + (diffInMinutes === 1 ? "" : "s") + " ago";
    } else if (diffInHours < 24) {
        return diffInHours + " hour" + (diffInHours === 1 ? "" : "s") + " ago";
    } else {
        return diffInDays + " day" + (diffInDays === 1 ? "" : "s") + " ago";
    }
}

async function connectToD1(searchValue="") {
    console.log(searchValue)
    let searchQuery = '/request/bookdatabase'
    if (searchValue) {
      searchQuery = '/request/bookdatabase/?search=' + searchValue;
    }
    console.log("Connecting to Cloudflare D1." + searchQuery);
    const response = await fetch(searchQuery);
    const books = await response.json();

    // Get the parent node
    var parentNode = document.querySelector('body');
    
    // Reset books shown
    const booksDivs = document.querySelectorAll('.book');
    booksDivs.forEach(bookDiv => {
      bookDiv.remove();
    });

    books.forEach(book => {
        const bookDiv = document.createElement('div');
        bookDiv.setAttribute("id", "bookId=" + book["BookId"]);
        bookDiv.setAttribute("class", "book");

        const bookInfo = document.createElement('div');

        const bookTitle = document.createElement('h2');
        bookTitle.textContent = book["Title"];
        bookInfo.appendChild(bookTitle);

        const bookAuthor = document.createElement('h3');
        bookAuthor.textContent = book["Author"];
        bookInfo.appendChild(bookAuthor);


        const scannedText = document.createElement('h4');
        if (!book["Title"] && !book["Author"]){
            scannedText.textContent = book["ScannedText"];
        }
        bookInfo.appendChild(scannedText);
        
        // Highlight matching text
        if (searchValue) {
          const regex = new RegExp(`(${searchValue})`, 'gi'); // Create a regex for case-insensitive matching
          const highlightedTitleText = bookTitle.innerHTML.replace(regex, '<span class="highlight">$1</span>');
          bookTitle.innerHTML = highlightedTitleText; // Update the text with highlights
          const highlightedAuthorText = bookAuthor.innerHTML.replace(regex, '<span class="highlight">$1</span>');
          bookAuthor.innerHTML = highlightedAuthorText; // Update the text with highlights
          const highlightedScannedText = scannedText.innerHTML.replace(regex, '<span class="highlight">$1</span>');
          scannedText.innerHTML = highlightedScannedText; // Update the text with highlights
        }

        if (book["Author"]){
          bookAuthor.innerHTML = "By " + bookAuthor.innerHTML;
        }

        if (!book["Title"] && !book["Author"]){
            scannedText.innerHTML = "SCANNED TEXT: " + scannedText.innerHTML + "<br><br>";
        }

        const bookLocation = document.createElement('a');
        let bookLocationString = '';
        if (book["Location"] === '4PYLziyxT1ASxtRSA'){
            bookLocationString = 'British Heart Foundation - Whiteladies Road';
        } else if (book["Location"] === 'ECwQXoWCDUHGarRz5') {
            bookLocationString = 'Oxfam - Cotham Hill';
        } else {
            bookLocationString = book['Location'];
        }
        bookLocation.setAttribute("href", "https://maps.app.goo.gl/" + book["Location"]);
        bookLocation.setAttribute("target", "_blank");
        bookLocation.textContent = "From " + bookLocationString;
        bookInfo.appendChild(bookLocation);

        const bookScanInfo = document.createElement('h4');
        bookScanInfo.textContent = 'Scanned ' + timeAgo(book["DateTimeScanned"]);
        bookInfo.appendChild(bookScanInfo);

        const googleBooksLink = document.createElement('a');
        googleBooksLink.setAttribute("href", "https://www.google.co.uk/books/edition/_/" + book["GBooksId"]);
        googleBooksLink.setAttribute("target", "_blank");
        googleBooksLink.textContent = "Google Books >";
        bookInfo.appendChild(googleBooksLink);

        imageUrl = "https://re-read.co.uk/request/bookdatabase/image?bookId=" + book["BookId"];
        const imgElement = document.createElement('img');
        imgElement.src = imageUrl;
        imgElement.alt = book["ScannedText"];

        bookDiv.appendChild(imgElement);
        bookDiv.appendChild(bookInfo);

        parentNode.appendChild(bookDiv);
	});
};

document.getElementById('search-form').addEventListener('submit', function(event) {
  // Prevent the default form submission behavior
  event.preventDefault();
  const searchValue = document.getElementById('search-input').value

  // Get the value of the search input
  if (searchValue) {
      //const searchQuery = '/request/bookdatabase/?search=' + searchValue;
      //console.log(searchQuery)

      connectToD1(searchValue);
  }
  else {
      connectToD1();
  }
})

connectToD1();

</script>
</body>

</html>
